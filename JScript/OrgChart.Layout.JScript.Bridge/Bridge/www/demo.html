<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <script src="jquery-3.1.1.min.js"></script>
    <script src="../output/bridge.min.js"></script>
    <script src="../output/bridge.collections.min.js"></script>
    <script src="../output/orgchart.layout.js"></script>
    <script src="../output/OrgStructureNodesDataItem.js"></script>
    <script src="../output/OrgStructureNodesDataSource.js"></script>
</head>
<body>

    <style>
        .chartBoxCollapsed {
            position: absolute;
            border: thin solid #000000;
            background-color: #d68910;
            font-size: x-small;
        }

        .chartBox {
            position: absolute;
            border: thin solid #000000;
            background-color: #fdedec;
            font-size: x-small;
        }

        .chartHLine {
            position: absolute;
            border-top: thin solid #000000;
        }

        .chartVLine {
            position: absolute;
            border-left: thin solid #000000;
        }
        
        .chartHLineDotted {
            position: absolute;
            border-top: thin dotted #000000;
        }

        .chartVLineDotted {
            position: absolute;
            border-left: thin dotted #000000;
        }
    </style>

    <div class="row">

        <div id="sample" style="position: relative;">
            <div id="myDiagramDiv" style="background-color: white; border: dotted 1px black; width: 10px; height: 10px">

            </div>
        </div>
    </div>

    <script>
        Bridge.define('ChartApp',
        {
            statics: {
                config: {
                    init: function() {

                    }
                },
                main: function() {
                    ChartApp.buildChart(null);
                },

                diagram: {},
                dataSource: {},

                boxClick: function(boxId) {
                    var box = ChartApp.diagram.getBoxes().getBoxesById().getItem(boxId);
                    box.IsCollapsed = !box.IsCollapsed;
                    ChartApp.renderBoxes();
                },

                buildChart: function(data) {
                    ChartApp.initDiagram(data);
                    ChartApp.renderBoxes();
                },

                collapseAllBoxes: function(boxContainer) {
                    var en = boxContainer.getBoxesById().getValues().getEnumerator();
                    while (en.moveNext()) {
                        var box = en.getCurrent();
                        if (!box.IsSpecial) {
                            box.IsCollapsed = true;
                        }
                    }
                },

                initDiagram: function(data) {
                    var dataSource = new OrgChart.Test.TestDataSource();
                    (new OrgChart.Test.TestDataGen()).GenerateDataItems(dataSource, 200);
					ChartApp.dataSource = dataSource;

                    var boxContainer = new OrgChart.Layout.BoxContainer.$ctor1(dataSource);
                    OrgChart.Test.TestDataGen.GenerateBoxSizes(boxContainer);

                    ChartApp.collapseAllBoxes(boxContainer);
                    
                    ChartApp.diagram = new OrgChart.Layout.Diagram();

                    var diagram = ChartApp.diagram;
                    diagram.setBoxes(boxContainer);

                    var linearLayoutStrategy = new OrgChart.Layout.LinearLayoutStrategy();
                    linearLayoutStrategy.ParentAlignment = OrgChart.Layout.BranchParentAlignment.Center;
                    diagram.LayoutSettings.LayoutStrategies.add("linear", linearLayoutStrategy);

                    var multiLineHangerLayoutStrategy = new OrgChart.Layout.MultiLineHangerLayoutStrategy();
                    multiLineHangerLayoutStrategy
                        .ParentAlignment = OrgChart.Layout.BranchParentAlignment.Center;
                    diagram.LayoutSettings.LayoutStrategies.add("hanger", multiLineHangerLayoutStrategy);

                    var singleColumnLayoutStrategy = new OrgChart.Layout.SingleColumnLayoutStrategy();
                    singleColumnLayoutStrategy.ParentAlignment = OrgChart.Layout.BranchParentAlignment.Right;
                    diagram.LayoutSettings.LayoutStrategies.add("singleColumn", singleColumnLayoutStrategy);

                    var fishboneLayoutStrategy = new OrgChart.Layout.MultiLineFishboneLayoutStrategy();
                    fishboneLayoutStrategy.ParentAlignment = OrgChart.Layout.BranchParentAlignment.Center;
                    fishboneLayoutStrategy.MaxGroups = 1;
                    diagram.LayoutSettings.LayoutStrategies.add("fishbone1", fishboneLayoutStrategy);

                    fishboneLayoutStrategy = new OrgChart.Layout.MultiLineFishboneLayoutStrategy();
                    fishboneLayoutStrategy.ParentAlignment = OrgChart.Layout.BranchParentAlignment.Center;
                    fishboneLayoutStrategy.MaxGroups = 2;
                    diagram.LayoutSettings.LayoutStrategies.add("fishbone2", fishboneLayoutStrategy);

                    var assistantsLayoutStrategy = new OrgChart.Layout.FishboneAssistantsLayoutStrategy();
                    assistantsLayoutStrategy.ParentAlignment = OrgChart.Layout.BranchParentAlignment.Center;
                    diagram.LayoutSettings.LayoutStrategies.add("assistants", assistantsLayoutStrategy);

                    diagram.LayoutSettings.DefaultLayoutStrategyId = "fishbone2";
                    diagram.LayoutSettings.DefaultAssistantLayoutStrategyId = "assistants";
                },

                renderBoxes: function() {
                    $("#myDiagramDiv").html('');

                    var boxContainer = ChartApp.diagram.getBoxes();
                    var dataSource = ChartApp.dataSource;
                    var diagram = ChartApp.diagram;

                    var state = new OrgChart.Layout.LayoutState(diagram);

                    OrgChart.Layout.LayoutAlgorithm.Apply(state);

                    var rect = OrgChart.Layout.LayoutAlgorithm
                        .ComputeBranchVisualBoundingRect(diagram.getVisualTree());
                    var margin = 10;
                    var offsetx = -rect.getLeft() + margin;
                    var offsety = -rect.getTop() + margin;
                    $("#myDiagramDiv").width(rect.Size.Width + margin*2);
                    $("#myDiagramDiv").height(rect.Size.Height + margin*2);

                    var visitorFunc = function (node) {
                        if (node.Level == 0) {
                            return true;
                        }

                        if (node.State.IsHidden) {
                            return true;
                        }

                        var box = node.Element;

                        if (box.getIsDataBound())
                        {
                            var boxClass;
                            boxClass = "chartBox";

                            if (box.IsCollapsed && (
                                node.getChildCount() > 0
                                || node.AssistantsRoot != null
                                && node.AssistantsRoot.getChildCount() > 0)) {
                                boxClass = boxClass + "Collapsed";
                            }

                            $("#myDiagramDiv")
                                .append('<div class="' +
                                    boxClass +
                                    '" style="top:' +
                                    (node.State.TopLeft.Y + offsety) +
                                    'px; left:' +
                                    (node.State.TopLeft.X + offsetx) +
                                    'px; width:' +
                                    node.State.Size.Width +
                                    'px; height:' +
                                    node.State.Size.Height +
                                    'px" onclick="ChartApp.boxClick(' +
                                    box.Id +
                                    ')">' +
                                    box.DataId +
                                    '</div>');
                        }

                        if (node.State.Connector != null) {
                            for (var ix = 0; ix < node.State.Connector.Segments.length; ix++) {
                                var edge = node.State.Connector.Segments[ix];
                                var edgeType;
                                var topLeft;
                                var width;
                                var height;
                                if (edge.From.Y == edge.To.Y) {
                                    edgeType = "chartHLine";
                                    height = 1;
                                    if (edge.From.X < edge.To.X) {
                                        topLeft = edge.From;
                                        width = edge.To.X - edge.From.X;
                                    } else {
                                        topLeft = edge.To;
                                        width = edge.From.X - edge.To.X;
                                    }
                                } else {
                                    edgeType = "chartVLine";
                                    if (edge.From.Y < edge.To.Y) {
                                        topLeft = edge.From;
                                        height = edge.To.Y - edge.From.Y;
                                    } else {
                                        topLeft = edge.To;
                                        height = edge.From.Y - edge.To.Y;
                                    }
                                }

                                if (node.getIsAssistantRoot()) {
                                    edgeType = edgeType + "Dotted";
                                }

                                $("#myDiagramDiv")
                                    .append('<div class="' +
                                        edgeType +
                                        '" style="top:' +
                                        (topLeft.Y + offsety) +
                                        'px; left:' +
                                        (topLeft.X + offsetx) +
                                        'px; width:' +
                                        width +
                                        'px; height:' +
                                        height +
                                        'px;"/>');
                            }
                        }

                        return true;
                    }

                    diagram.getVisualTree().IterateChildFirst(visitorFunc);
                }
            }
        });

        Bridge.init();
        ChartApp.main();

    </script>
</body>
</html>